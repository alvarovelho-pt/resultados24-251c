<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pedag√≥gico - 1¬∫ Ciclo</title>
    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --primary: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --level-1-2: #ef4444; /* Insufficient */
            --level-3: #eab308;   /* Sufficient */
            --level-4-5: #22c55e; /* Good/Very Good */
            --diff-positive: #22c55e;
            --diff-negative: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* Layout */
        .sidebar { width: 280px; background: var(--bg-card); border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; padding: 1.5rem; overflow-y: auto; z-index: 10; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; }

        /* Typography */
        h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; }
        h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
        h3 { font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 0.75rem; }
        p { font-size: 0.875rem; color: var(--text-secondary); }

        /* Sidebar Elements */
        .logo-area { margin-bottom: 2rem; }
        .stat-list { list-style: none; display: flex; flex-direction: column; gap: 0.75rem; }
        .stat-item { padding: 0.75rem; border-radius: 0.5rem; background: #f9fafb; border: 1px solid #e5e7eb; }
        .stat-item strong { display: block; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .stat-item span { font-size: 0.8rem; }
        .badge { display: inline-block; padding: 0.25em 0.5em; font-size: 0.75rem; border-radius: 999px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Header & Controls */
        .header-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; background: var(--bg-card); padding: 1rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .grade-toggles { display: flex; background: #f3f4f6; padding: 0.25rem; border-radius: 0.5rem; gap: 0.25rem; }
        .toggle-btn { padding: 0.5rem 1rem; border: none; background: transparent; cursor: pointer; border-radius: 0.375rem; font-weight: 500; font-size: 0.875rem; color: var(--text-secondary); transition: all 0.2s; }
        .toggle-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .help-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid #e5e7eb; background: white; color: var(--primary); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .help-btn:hover { background: var(--primary); color: white; }
        
        .control-group { display: flex; gap: 1.5rem; align-items: center; }

        .view-switch { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .sort-select { padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; font-size: 0.875rem; color: var(--text-main); background: #f9fafb; cursor: pointer; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
        .kpi-card { background: var(--bg-card); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-value { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; color: var(--text-main); }
        .kpi-label { font-size: 0.875rem; color: var(--text-secondary); }
        .kpi-bar-container { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 1rem; display: flex; }
        .kpi-bar { height: 100%; transition: width 0.5s ease; }

        /* Level Summary Bar */
        .summary-container { background: var(--bg-card); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; margin-top: -0.5rem; }
        .summary-bar-wrapper { display: flex; height: 24px; border-radius: 12px; overflow: hidden; margin-top: 1rem; }
        .summary-segment { display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600; transition: width 0.5s ease; position: relative; }
        .summary-segment:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 4px 8px; border-radius: 4px; white-space: nowrap; margin-bottom: 4px; pointer-events: none; }

        /* Main Chart Area */
        .chart-container { background: var(--bg-card); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 400px; display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; align-items: center; }
        .legend { display: flex; gap: 1rem; font-size: 0.75rem; }
        .legend-item { display: flex; align-items: center; gap: 0.25rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        /* SVG Chart Styling */
        .bar-group text { font-size: 12px; fill: var(--text-secondary); }
        .bar-rect { transition: height 0.3s, y 0.3s, width 0.3s, x 0.3s; cursor: pointer; }
        .bar-rect:hover { opacity: 0.9; }
        .grid-line { stroke: #e5e7eb; stroke-dasharray: 4; }
        
        /* Tooltip */
        .tooltip { position: absolute; background: #1f2937; color: white; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Modal (Guide) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .guide-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .guide-section:last-child { border-bottom: none; }
        .guide-title { font-weight: 600; color: var(--primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .guide-text { font-size: 0.9rem; line-height: 1.5; color: var(--text-main); }
        .guide-list { margin-left: 1rem; font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .guide-list li { margin-bottom: 0.25rem; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #e5e7eb; padding: 1rem; }
            .main-content { padding: 1rem; }
            .header-controls { flex-direction: column; align-items: stretch; }
            .control-group { flex-direction: column; align-items: stretch; gap: 1rem; }
            .grade-toggles { overflow-x: auto; }
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-area">
            <h1>EduDash</h1>
            <p>1¬∫ Ciclo (Anos 1-4)</p>
            <p style="font-size: 0.75rem; margin-top:0.25rem;">Dados: PDF Ciclo 1</p>
        </div>

        <h3>Top 5 - Qualidade</h3>
        <p style="font-size: 0.7rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Disciplinas com maior % N√≠veis 4 e 5</p>
        <ul class="stat-list" id="top3List">
            <!-- Populated by JS -->
        </ul>

        <h3 style="margin-top: 2rem; color: var(--danger);">Aten√ß√£o Necess√°ria</h3>
        <p style="font-size: 0.75rem; margin-bottom: 0.5rem;">Maior taxa de insufici√™ncia (N√≠veis 1+2)</p>
        <ul class="stat-list" id="attentionList">
            <!-- Populated by JS -->
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Controls Header -->
        <header class="header-controls">
            <div class="grade-toggles">
                <button class="toggle-btn" onclick="setGrade('cycle')">1¬∫ Ciclo</button>
                <button class="toggle-btn" onclick="setGrade('1')">1¬∫ Ano</button>
                <button class="toggle-btn" onclick="setGrade('2')">2¬∫ Ano</button>
                <button class="toggle-btn" onclick="setGrade('3')">3¬∫ Ano</button>
                <button class="toggle-btn" onclick="setGrade('4')">4¬∫ Ano</button>
            </div>

            <div class="control-group">
                <select id="sortSelect" class="sort-select" onchange="updateUI()">
                    <option value="default">Ordena√ß√£o Padr√£o</option>
                    <option value="successDesc">Sucesso Global (Desc)</option>
                    <option value="qualityDesc">Qualidade Sucesso (Desc)</option>
                    <option value="failureDesc">Taxa Insucesso (Desc)</option>
                </select>

                <div class="view-switch">
                    <span>Padr√£o</span>
                    <label class="switch">
                        <input type="checkbox" id="diffToggle" onchange="toggleView()">
                        <span class="slider"></span>
                    </label>
                    <span>Diferencial</span>
                </div>

                <button class="help-btn" onclick="toggleGuide()" title="Guia de Utilizador">?</button>
            </div>
        </header>

        <div style="font-size: 0.875rem; color: var(--text-secondary); text-align: right; margin-top: -0.5rem;">
            Ano Letivo: <strong id="currentYearDisplay">2024/2025 (3¬∫ P)</strong>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid" id="kpiContainer">
            <!-- Populated by JS -->
        </div>

        <!-- Summary Bar -->
        <div class="summary-container" id="summaryContainer" style="display:none;">
            <h3 style="margin-bottom: 0;">Resumo da Distribui√ß√£o de N√≠veis (M√©dia Ponderada)</h3>
            <div class="summary-bar-wrapper" id="summaryBar">
                <!-- Injected via JS -->
            </div>
            <div class="legend" style="margin-top: 0.75rem; justify-content: center;">
                <div class="legend-item"><div class="dot" style="background:var(--level-1-2)"></div>Insuficiente (1-2)</div>
                <div class="legend-item"><div class="dot" style="background:var(--level-3)"></div>Suficiente (3)</div>
                <div class="legend-item"><div class="dot" style="background:var(--level-4-5)"></div>Bom/M.Bom (4-5)</div>
            </div>
        </div>

        <!-- Main Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 id="chartTitle">Distribui√ß√£o por Disciplina</h2>
                <div class="legend" id="chartLegend">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div id="chartCanvas" style="flex: 1; width: 100%; position: relative;">
                <!-- SVG Chart Injected Here -->
            </div>
        </div>

    </main>

    <!-- Guide Modal -->
    <div class="modal-overlay" id="guideModal">
        <div class="modal-content">
            <button class="modal-close" onclick="toggleGuide()">&times;</button>
            <h2 style="text-align: center; margin-bottom: 1.5rem;">Guia de Utilizador</h2>
            
            <div class="guide-section">
                <div class="guide-title">üìä Indicadores de Desempenho (KPIs)</div>
                <p class="guide-text">
                    Cart√µes no topo que fornecem uma vis√£o r√°pida do estado geral:
                </p>
                <ul class="guide-list">
                    <li><strong>Taxa Global de Sucesso:</strong> Percentagem m√©dia de alunos com n√≠vel igual ou superior a 3.</li>
                    <li><strong>Qualidade do Sucesso:</strong> Percentagem m√©dia de alunos que obtiveram n√≠veis 4 ou 5 (Bom ou Muito Bom).</li>
                    <li><strong>Taxa Global de Insucesso:</strong> Percentagem m√©dia de alunos com n√≠veis 1 ou 2 (Insuficiente).</li>
                </ul>
            </div>

            <div class="guide-section">
                <div class="guide-title">üéõÔ∏è Funcionalidades e Controlos</div>
                <p class="guide-text">Utilize a barra superior para personalizar a visualiza√ß√£o:</p>
                <ul class="guide-list">
                    <li><strong>Sele√ß√£o de Ano:</strong> Escolha entre a vis√£o global ("1¬∫ Ciclo") ou os dados espec√≠ficos de cada ano (1¬∫ a 4¬∫).</li>
                    <li><strong>Ordena√ß√£o:</strong> Reorganize o gr√°fico principal por Sucesso, Qualidade ou Insucesso.</li>
                    <li><strong>Alternador de Vista (Padr√£o vs Diferencial):</strong>
                        <br><em>Padr√£o:</em> Mostra as taxas atuais do ano letivo 2024/2025.
                        <br><em>Diferencial:</em> Mostra a varia√ß√£o (evolu√ß√£o) em compara√ß√£o com o ano anterior (23/24). Barras verdes indicam melhoria, vermelhas indicam piora.
                    </li>
                </ul>
            </div>

            <div class="guide-section">
                <div class="guide-title">üìâ Gr√°ficos e Listas</div>
                <ul class="guide-list">
                    <li><strong>Barra de Resumo:</strong> Uma barra colorida que representa a m√©dia ponderada de todos os n√≠veis (Vermelho: 1-2, Amarelo: 3, Verde: 4-5).</li>
                    <li><strong>Top 5 - Qualidade:</strong> Lista lateral com as 5 disciplinas que apresentam a maior percentagem de n√≠veis 4 e 5.</li>
                    <li><strong>Aten√ß√£o Necess√°ria:</strong> Lista lateral que destaca disciplinas com taxas de insucesso (n√≠veis 1 e 2), ordenada da maior para a menor taxa.</li>
                </ul>
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <button class="toggle-btn active" style="background:var(--primary); color:white;" onclick="toggleGuide()">Entendido</button>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

<script>
    /**
     * DATA STORE
     * Extracted from ciclo1.pdf
     * Data refers to 2024/2025 3rd Period results and the extracted differentials.
     */
    
    const db = {
        cycle: {
            title: "1¬∫ Ciclo (Global)",
            subjects: [
                { name: "Portugu√™s", l1: 0, l2: 6.39, l3: 26.47, l45: 67.14, diff_l12: -2.16, diff_l45: 3.92 },
                { name: "Matem√°tica", l1: 0, l2: 7.10, l3: 24.51, l45: 68.38, diff_l12: 4.46, diff_l45: 2.66 },
                { name: "Estudo do Meio", l1: 0, l2: 3.19, l3: 18.26, l45: 78.55, diff_l12: 3.60, diff_l45: 4.79 },
                { name: "Ed. Art", l1: 0, l2: 0.18, l3: 14.06, l45: 85.77, diff_l12: 4.67, diff_l45: 5.26 },
                { name: "EF", l1: 0, l2: 0.18, l3: 16.55, l45: 83.27, diff_l12: 3.27, diff_l45: 0.48 },
                { name: "Apoio Estudo", l1: 0, l2: 2.15, l3: 23.3, l45: 74.38, diff_l12: -1.47, diff_l45: 0.38 }, // Extrapolated
                { name: "Ingl√™s", l1: 0, l2: 1.96, l3: 15.14, l45: 84.86, diff_l12: -0.69, diff_l45: 4.45 }
            ]
        },
        1: {
            title: "1¬∫ Ano",
            subjects: [
                { name: "Portugu√™s", l1: 0, l2: 10.22, l3: 21.17, l45: 68.61, diff_l12: 4.57, diff_l45: 11.57 },
                { name: "Matem√°tica", l1: 0, l2: 9.49, l3: 18.98, l45: 71.53, diff_l12: 2.04, diff_l45: 14.78 },
                { name: "Estudo do Meio", l1: 0, l2: 7.25, l3: 11.59, l45: 81.16, diff_l12: 1.33, diff_l45: 13.65 },
                { name: "Ed. Art", l1: 0, l2: 0.74, l3: 15.44, l45: 83.82, diff_l12: -0.53, diff_l45: 9.21 },
                { name: "EF", l1: 0, l2: 0.73, l3: 13.14, l45: 86.13, diff_l12: 0.73, diff_l45: 5.85 },
                { name: "Apoio Estudo", l1: 0, l2: 3.65, l3: 21.90, l45: 74.45, diff_l12: 4.10, diff_l45: 19.52 },
                { name: "OC", l1: 0, l2: 0, l3: 23.36, l45: 76.64, diff_l12: 0, diff_l45: 9.74 }
            ]
        },
        2: {
            title: "2¬∫ Ano",
            subjects: [
                { name: "Portugu√™s", l1: 0, l2: 13.48, l3: 31.21, l45: 55.32, diff_l12: 8.68, diff_l45: -13.86 },
                { name: "Matem√°tica", l1: 0, l2: 14.89, l3: 22.70, l45: 62.41, diff_l12: 10.78, diff_l45: -5.40 },
                { name: "Estudo do Meio", l1: 0, l2: 4.26, l3: 21.28, l45: 74.47, diff_l12: 2.20, diff_l45: -7.72 },
                { name: "Ed. Art", l1: 0, l2: 0, l3: 21.99, l45: 78.01, diff_l12: 0, diff_l45: -8.97 },
                { name: "EF", l1: 0, l2: 0, l3: 26.24, l45: 73.76, diff_l12: 0, diff_l45: -12.54 },
                { name: "Apoio Estudo", l1: 0, l2: 4.26, l3: 33.33, l45: 62.41, diff_l12: 3.57, diff_l45: -6.08 },
                { name: "OC", l1: 0, l2: 0, l3: 19.15, l45: 80.85, diff_l12: 0, diff_l45: -11.61 }
            ]
        },
        3: {
            title: "3¬∫ Ano",
            subjects: [
                { name: "Portugu√™s", l1: 0, l2: 2.04, l3: 28.57, l45: 69.39, diff_l12: 0.61, diff_l45: -2.04 },
                { name: "Matem√°tica", l1: 0, l2: 2.72, l3: 30.61, l45: 66.67, diff_l12: 2.01, diff_l45: -7.62 },
                { name: "Estudo do Meio", l1: 0, l2: 1.36, l3: 21.09, l45: 77.55, diff_l12: 0.61, diff_l45: -6.74 },
                { name: "Ed. Art", l1: 0, l2: 0, l3: 9.52, l45: 90.48, diff_l12: 0, diff_l45: 4.77 },
                { name: "EF", l1: 0, l2: 0, l3: 8.22, l45: 91.78, diff_l12: 0, diff_l45: 1.78 },
                { name: "Apoio Estudo", l1: 0, l2: 0, l3: 23.13, l45: 76.87, diff_l12: 0, diff_l45: -0.83 },
                { name: "Ingl√™s", l1: 0, l2: 0, l3: 10.88, l45: 89.12, diff_l12: 0, diff_l45: 14.83 }
            ]
        },
        4: {
            title: "4¬∫ Ano",
            subjects: [
                { name: "Portugu√™s", l1: 0, l2: 0, l3: 24.64, l45: 75.36, diff_l12: -0.72, diff_l45: 9.42 },
                { name: "Matem√°tica", l1: 0, l2: 1.45, l3: 25.36, l45: 73.19, diff_l12: 2.17, diff_l45: 13.04 },
                { name: "Estudo do Meio", l1: 0, l2: 0, l3: 18.84, l45: 81.16, diff_l12: 0.72, diff_l45: -9.42 },
                { name: "Ed. Art", l1: 0, l2: 0, l3: 9.42, l45: 90.58, diff_l12: 0, diff_l45: 10.87 },
                { name: "EF", l1: 0, l2: 0, l3: 18.84, l45: 81.16, diff_l12: 0.72, diff_l45: -8.70 },
                { name: "Apoio Estudo", l1: 0, l2: 0, l3: 16.06, l45: 83.94, diff_l12: 1.45, diff_l45: 7.13 },
                { name: "Ingl√™s", l1: 0, l2: 0, l3: 19.71, l45: 80.29, diff_l12: 0, diff_l45: -0.87 }
            ]
        }
    };

    let state = {
        grade: 'cycle',
        diffMode: false,
        sortBy: 'default'
    };

    // Guide Logic
    function toggleGuide() {
        const modal = document.getElementById('guideModal');
        modal.classList.toggle('active');
    }

    // State Management
    function setGrade(grade) {
        state.grade = grade;
        updateUI();
        
        // Highlight active button
        const buttons = document.querySelectorAll('.toggle-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('onclick').includes(`'${grade}'`)) {
                btn.classList.add('active');
            }
        });
    }

    function toggleView() {
        state.diffMode = document.getElementById('diffToggle').checked;
        updateUI();
    }

    // Core Logic
    function updateUI() {
        state.sortBy = document.getElementById('sortSelect').value;
        const dataset = db[state.grade];
        document.getElementById('chartTitle').innerText = state.diffMode 
            ? `Diferencial 23/24 vs 24/25 - ${dataset.title}` 
            : `Distribui√ß√£o de N√≠veis - ${dataset.title}`;
        
        renderKPIs(dataset);
        renderSummaryBar(dataset);
        renderSidebar(dataset);
        renderChart(dataset);
    }

    function renderKPIs(dataset) {
        const container = document.getElementById('kpiContainer');
        container.innerHTML = '';

        if(state.diffMode) {
            // Differential KPIs
            const subjects = dataset.subjects;
            let avgDiffPos = subjects.reduce((acc, s) => acc + s.diff_l45, 0) / subjects.length;
            let avgDiffNeg = subjects.reduce((acc, s) => acc + s.diff_l12, 0) / subjects.length;

            const cards = [
                { label: 'Varia√ß√£o M√©dia Qualidade (N√≠veis 4/5)', value: avgDiffPos, inverse: false },
                { label: 'Varia√ß√£o M√©dia Insufici√™ncia (N√≠veis 1/2)', value: avgDiffNeg, inverse: true }
            ];

            cards.forEach(c => {
                const isPositiveGood = !c.inverse; 
                const color = c.value > 0 
                    ? (isPositiveGood ? 'var(--success)' : 'var(--danger)')
                    : (isPositiveGood ? 'var(--danger)' : 'var(--success)');
                
                const sign = c.value > 0 ? '+' : '';
                
                container.innerHTML += `
                    <div class="kpi-card">
                        <div class="kpi-label">${c.label}</div>
                        <div class="kpi-value" style="color: ${color}">${sign}${c.value.toFixed(2)}%</div>
                        <div style="font-size:0.8rem; color:#6b7280;">${c.value > 0 ? 'Aumento' : 'Diminui√ß√£o'} face ao ano anterior</div>
                    </div>
                `;
            });
        } else {
            // Standard KPIs
            let avgSuccess = 0;
            let avgQuality = 0;
            let avgFailure = 0;
            let count = 0;

            dataset.subjects.forEach(s => {
                let failure = s.l1 + s.l2;
                let success = s.l3 + s.l45;
                avgSuccess += success;
                avgQuality += s.l45;
                avgFailure += failure;
                count++;
            });

            avgSuccess /= count;
            avgQuality /= count;
            avgFailure /= count;

            // Sucesso Global
            container.innerHTML += `
                <div class="kpi-card">
                    <div class="kpi-label">Taxa Global de Sucesso (‚â•3)</div>
                    <div class="kpi-value">${avgSuccess.toFixed(1)}%</div>
                    <div class="kpi-bar-container">
                        <div class="kpi-bar" style="width: ${avgSuccess}%; background: var(--primary)"></div>
                    </div>
                </div>
            `;

            // Qualidade
            container.innerHTML += `
                <div class="kpi-card">
                    <div class="kpi-label">Qualidade do Sucesso (4 e 5)</div>
                    <div class="kpi-value">${avgQuality.toFixed(1)}%</div>
                    <div class="kpi-bar-container">
                        <div class="kpi-bar" style="width: ${avgQuality}%; background: var(--success)"></div>
                    </div>
                </div>
            `;

            // Insucesso (New)
            container.innerHTML += `
                <div class="kpi-card">
                    <div class="kpi-label">Taxa Global de Insucesso (<3)</div>
                    <div class="kpi-value" style="color: var(--danger);">${avgFailure.toFixed(1)}%</div>
                    <div class="kpi-bar-container">
                        <div class="kpi-bar" style="width: ${avgFailure}%; background: var(--danger)"></div>
                    </div>
                </div>
            `;
        }
    }

    function renderSummaryBar(dataset) {
        const container = document.getElementById('summaryContainer');
        const bar = document.getElementById('summaryBar');
        
        if (state.diffMode) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        
        let totalFailure = 0;
        let totalSufficient = 0;
        let totalQuality = 0;
        let count = 0;

        dataset.subjects.forEach(s => {
            totalFailure += (s.l1 + s.l2);
            totalSufficient += s.l3;
            totalQuality += s.l45;
            count++;
        });

        const avgF = totalFailure / count;
        const avgS = totalSufficient / count;
        const avgQ = totalQuality / count;

        bar.innerHTML = `
            <div class="summary-segment" data-tooltip="Insuficiente: ${avgF.toFixed(1)}%" style="width: ${avgF}%; background: var(--level-1-2);"></div>
            <div class="summary-segment" data-tooltip="Suficiente: ${avgS.toFixed(1)}%" style="width: ${avgS}%; background: var(--level-3);"></div>
            <div class="summary-segment" data-tooltip="Bom/M.Bom: ${avgQ.toFixed(1)}%" style="width: ${avgQ}%; background: var(--level-4-5);"></div>
        `;
    }

    function renderSidebar(dataset) {
        // Top 5 (Highest Quality)
        const sortedByQuality = [...dataset.subjects].sort((a,b) => b.l45 - a.l45).slice(0,5);
        const top3List = document.getElementById('top3List');
        top3List.innerHTML = sortedByQuality.map(s => `
            <li class="stat-item" style="border-left: 4px solid var(--success);">
                <strong>${s.name}</strong>
                <span class="badge badge-success">${s.l45.toFixed(1)}% Qualidade</span>
            </li>
        `).join('');

        // Attention (Failure L1+L2 > 0)
        const sortedByFailure = [...dataset.subjects]
            .filter(s => (s.l1 + s.l2) > 0)
            .sort((a,b) => (b.l1+b.l2) - (a.l1+a.l2));

        const attList = document.getElementById('attentionList');
        
        if (sortedByFailure.length === 0) {
            attList.innerHTML = '<li style="font-size:0.8rem; color:var(--text-secondary);">Sem registo de n√≠veis 1 ou 2.</li>';
        } else {
            attList.innerHTML = sortedByFailure.map(s => `
                <li class="stat-item" style="border-left: 4px solid var(--danger);">
                    <strong>${s.name}</strong>
                    <span class="badge badge-danger">${(s.l1+s.l2).toFixed(2)}% Insuf.</span>
                </li>
            `).join('');
        }
    }

    function renderChart(dataset) {
        const container = document.getElementById('chartCanvas');
        const legend = document.getElementById('chartLegend');
        container.innerHTML = '';
        legend.innerHTML = '';

        const width = container.clientWidth;
        
        // Clone and Sort Data
        let subjects = [...dataset.subjects];
        
        if (state.sortBy === 'successDesc') {
            subjects.sort((a,b) => (b.l3 + b.l45) - (a.l3 + a.l45));
        } else if (state.sortBy === 'qualityDesc') {
            subjects.sort((a,b) => b.l45 - a.l45);
        } else if (state.sortBy === 'failureDesc') {
            subjects.sort((a,b) => (b.l1 + b.l2) - (a.l1 + a.l2));
        }

        // Adjust height based on number of items
        const barHeight = 30;
        const gap = 20;
        const height = (subjects.length * (barHeight + gap)) + 40;
        const margin = { top: 20, right: 20, bottom: 20, left: 120 };
        
        if (state.diffMode) {
            // Diverging Chart
            legend.innerHTML = `
                <div class="legend-item"><div class="dot" style="background:var(--success)"></div>Melhoria</div>
                <div class="legend-item"><div class="dot" style="background:var(--danger)"></div>Piora</div>
            `;

            let svgContent = '';
            const maxVal = Math.max(...subjects.map(s => Math.abs(s.diff_l45))) * 1.2 || 10;
            const center = (width - margin.left - margin.right) / 2 + margin.left;
            const scale = (center - margin.left) / maxVal;

            subjects.forEach((s, i) => {
                const y = margin.top + i * (barHeight + gap);
                const val = s.diff_l45;
                const barWidth = Math.abs(val) * scale;
                const x = val >= 0 ? center : center - barWidth;
                const color = val >= 0 ? 'var(--diff-positive)' : 'var(--diff-negative)';

                // Bar
                svgContent += `<rect class="bar-rect" x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="4" 
                    onmousemove="showTooltip(evt, '${s.name}: ${val > 0 ? '+' : ''}${val}%')" onmouseout="hideTooltip()" />`;
                
                // Label
                svgContent += `<text x="${margin.left - 10}" y="${y + barHeight/1.5}" text-anchor="end" fill="#374151" font-size="12">${s.name}</text>`;
                
                // Value Text
                svgContent += `<text x="${val >= 0 ? x + barWidth + 5 : x - 5}" y="${y + barHeight/1.5}" 
                    text-anchor="${val >= 0 ? 'start' : 'end'}" fill="#6b7280" font-size="11">${val > 0 ? '+' : ''}${val.toFixed(1)}%</text>`;
            });

            // Center Line
            svgContent += `<line x1="${center}" y1="${margin.top}" x2="${center}" y2="${height-margin.bottom}" stroke="#9ca3af" stroke-width="1" stroke-dasharray="4"/>`;

            container.innerHTML = `<svg width="100%" height="${height}">${svgContent}</svg>`;

        } else {
            // Stacked Bar Chart
            legend.innerHTML = `
                <div class="legend-item"><div class="dot" style="background:var(--level-4-5)"></div>N√≠veis 4-5</div>
                <div class="legend-item"><div class="dot" style="background:var(--level-3)"></div>N√≠vel 3</div>
                <div class="legend-item"><div class="dot" style="background:var(--level-1-2)"></div>N√≠veis 1-2</div>
            `;

            let svgContent = '';
            
            subjects.forEach((s, i) => {
                const y = margin.top + i * (barHeight + gap);
                const chartWidth = width - margin.left - margin.right;
                
                const w12 = (s.l1 + s.l2) / 100 * chartWidth;
                const w3 = s.l3 / 100 * chartWidth;
                const w45 = s.l45 / 100 * chartWidth;

                // Labels
                svgContent += `<text x="${margin.left - 10}" y="${y + barHeight/1.5}" text-anchor="end" fill="#374151" font-size="12">${s.name}</text>`;

                // Bars
                // Red (1-2)
                if(w12 > 0) svgContent += `<rect class="bar-rect" x="${margin.left}" y="${y}" width="${w12}" height="${barHeight}" fill="var(--level-1-2)" 
                    onmousemove="showTooltip(evt, 'Insuficiente: ${(s.l1+s.l2).toFixed(1)}%')" onmouseout="hideTooltip()"/>`;
                
                // Yellow (3)
                if(w3 > 0) svgContent += `<rect class="bar-rect" x="${margin.left + w12}" y="${y}" width="${w3}" height="${barHeight}" fill="var(--level-3)" 
                    onmousemove="showTooltip(evt, 'Suficiente: ${s.l3.toFixed(1)}%')" onmouseout="hideTooltip()"/>`;

                // Green (4-5)
                if(w45 > 0) svgContent += `<rect class="bar-rect" x="${margin.left + w12 + w3}" y="${y}" width="${w45}" height="${barHeight}" fill="var(--level-4-5)" 
                    onmousemove="showTooltip(evt, 'Bom/M.Bom: ${s.l45.toFixed(1)}%')" onmouseout="hideTooltip()"/>`;
            });

            container.innerHTML = `<svg width="100%" height="${height}">${svgContent}</svg>`;
        }
    }

    // Tooltip Logic
    function showTooltip(evt, text) {
        const tooltip = document.getElementById('tooltip');
        tooltip.style.display = 'block';
        tooltip.innerHTML = text;
        tooltip.style.left = evt.pageX + 10 + 'px';
        tooltip.style.top = evt.pageY + 10 + 'px';
        tooltip.style.opacity = 1;
    }

    function hideTooltip() {
        const tooltip = document.getElementById('tooltip');
        tooltip.style.opacity = 0;
        setTimeout(() => tooltip.style.display = 'none', 200);
    }

    // Init
    setGrade('cycle'); // Default view
    window.addEventListener('resize', updateUI); // Responsive redraw

</script>
</body>
</html>